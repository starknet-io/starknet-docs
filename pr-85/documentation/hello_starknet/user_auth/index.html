<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Adding User Authentication :: StarkNet documentation</title>
    <link rel="canonical" href="https://docs.starknet.io/documentation/hello_starknet/user_auth/">
    <link rel="prev" href="../calling_contracts/">
    <link rel="next" href="../deploying_from_contracts/">
    <meta name="generator" content="Antora 3.1.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129128514-2"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-129128514-2')</script>
    <script>var uiRootPath = '../../../_'</script>
    <link rel="icon" href="../../../favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <img src="/_/img/starknet_logo.png" alt="StarkNet logo" width="40px" height="40px" style="margin-top: 10px">
      <a class="navbar-item" href="https://docs.starknet.io"><strong>StarkNet documentation</strong></a>
      <!-- <span class="vertical-separator-header">|</span> -->
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs" >
          </div>
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://starknet.io/docs/hello_starknet/index.html#hello-starknet" target="_blank">Hello StarkNet</a>
        <a class="navbar-item" href="https://community.starknet.io/" target="_blank">StarkNet Community Forum</a>
        <a class="navbar-item" href="http://starknet.io/discord" target="_blank">Discord</a>
      </div>
    </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="documentation" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../">StarkNet</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">What Is StarkNet</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../Ecosystem/con_block_explorers/">StarkNet block explorers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developing on StarkNet</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Blocks and transactions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Blocks/header/">Block structure</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Blocks/transaction-life-cycle/">Transaction lifecycle</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Blocks/transactions/">Transaction structure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hashing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Hashing/hash-functions/">Hash functions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../develop/CLI/commands/">StarkNet CLI reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Contracts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Contracts/contract-abi/">Contract ABI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Contracts/contract-address/">Contract address</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Contracts/contract-classes/">Contract classes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Contracts/contract-hash/">Contract hash</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Contracts/contract-storage/">Contract storage</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Data Availability</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Data_Availability/on-chain-data/">On-chain data</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Events</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Events/starknet-events/">StarkNet events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fees</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/Fees/fee-mechanism/">Fee mechanism</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">L1-L2 Communication</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/L1-L2_Communication/messaging-mechanism/">Messaging mechanism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/L1-L2_Communication/token-bridge/">StarkGate – Token Bridge</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">State</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../develop/State/starknet-state/">StarkNet state</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hello StarkNet</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../writing_contracts/">Writing contracts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../account_setup/">Account setup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amm/">AMM</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../calling_contracts/">Calling contracts</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">User authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploying_from_contracts/">Deploying from contracts</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">StarkNet</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../">StarkNet</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">StarkNet</a></li>
    <li>Hello StarkNet</li>
    <li><a href="./">User authentication</a></li>
  </ul>
</nav>
<!--
  <div class="edit-this-page"><a href="https://github.com/starknet-community-libs/starknet-docs/edit/HEAD/components/StarkNet/modules/hello_starknet/pages/user_auth.adoc">Edit this Page</a></div>
  -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Adding User Authentication</h1>
<div class="sect1">
<h2 id="storage-maps"><a class="anchor" href="#storage-maps"></a>Storage maps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Suppose that instead of maintaining one global variable <code>balance</code>, we would like to have a balance for each user (users will be identified by their STARK public keys).</p>
</div>
<div class="paragraph">
<p>Our first task will be to change the <code>balance</code> storage variable to a map from public key (user) to balance (instead of a single value). This can be done by simply adding an argument:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// A map from user (represented by account contract address)
// to their balance.
@storage_var
func balance(user: felt) -&gt; (res: felt) {
}</pre>
</div>
</div>
<div class="paragraph">
<p>In fact, the <code>@storage_var</code> decorator allows you to add multiple arguments to create even more complicated maps. The functions <code>balance.read()</code> and <code>balance.write()</code> will now have the following signatures:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>func read{
    syscall_ptr: felt*,
    range_check_ptr,
    pedersen_ptr: HashBuiltin*,
}(user: felt) -&gt; (res: felt) {
}

func write{
    syscall_ptr: felt*,
    range_check_ptr,
    pedersen_ptr: HashBuiltin*,
}(user: felt, value: felt) {
}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the default value of all the entries in the map is 0.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting_the_caller_address"><a class="anchor" href="#getting_the_caller_address"></a>Getting the caller address</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to obtain the address of the account contract (or any other contract, in the case that the function was invoked by a contract) that invoked our function, we can use the <code>get_caller_address()</code> library function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>from starkware.starknet.common.syscalls import get_caller_address

// ...

let (caller_address) = get_caller_address();</pre>
</div>
</div>
<div class="paragraph">
<p><code>get_caller_address()</code> returns the address of the source contract that called this contract. It can be the address of the account contract or the address of another contract (if the function was invoked by another contract). When the contract is called directly (rather than through a contract), the function returns 0.</p>
</div>
<div class="paragraph">
<p>Note that if you use <code>get_caller_address()</code> in a function <code>foo()</code> that was called by another function <code>bar()</code> within your contract, it will still return the address of the contract that invoked <code>bar()</code> (or 0 if it was invoked directly).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modifying-the-contract-s-functions"><a class="anchor" href="#modifying-the-contract-s-functions"></a>Modifying the contract’s functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Change the code of <code>increase_balance()</code> to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>from starkware.cairo.common.math import assert_nn

// Increases the balance of the user by the given amount.
@external
func increase_balance{
    syscall_ptr: felt*,
    pedersen_ptr: HashBuiltin*,
    range_check_ptr,
}(amount: felt) {
    // Verify that the amount is positive.
    with_attr error_message(
            "Amount must be positive. Got: {amount}.") {
        assert_nn(amount);
    }

    // Obtain the address of the account contract.
    let (user) = get_caller_address();

    // Read and update its balance.
    let (res) = balance.read(user=user);
    balance.write(user, res + amount);
    return ();
}</pre>
</div>
</div>
<div class="paragraph">
<p>Note that we added a constraint that the value of <code>amount</code> must be nonnegative, by calling <code>assert_nn</code>. In order to obtain an indicative message in case of an error, we wrapped the function call with the <code>with_attr error_message(...)</code> block. See <a href="https://www.cairo-lang.org/docs/hello_starknet/user_auth.html#revert-reason">Retrieving the revert reason</a> for more details.</p>
</div>
<div class="paragraph">
<p>Similarly, change the code of <code>get_balance()</code>. Here we chose to allow the caller to query any user (since StarkNet’s storage is not private anyway):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>// Returns the balance of the given user.
@view
func get_balance{
    syscall_ptr: felt*,
    pedersen_ptr: HashBuiltin*,
    range_check_ptr,
}(user: felt) -&gt; (res: felt) {
    let (res) = balance.read(user=user);
    return (res=res);
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compile_and_deploy"><a class="anchor" href="#compile_and_deploy"></a>Compile and deploy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Save the new contract file as <code>user_auth.cairo</code>. You can find the full Cairo file <a href="https://www.cairo-lang.org/docs/_static/user_auth.cairo">here</a>.</p>
</div>
<div class="paragraph">
<p>Compile and declare the contract:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet-compile user_auth.cairo \
    --output user_auth_compiled.json \
    --abi user_auth_abi.json
starknet declare --contract user_auth_compiled.json</pre>
</div>
</div>
<div class="paragraph">
<p>Deploy the contract:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet deploy --class_hash ${USER_AUTH_CLASS_HASH}</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>${USER_AUTH_CLASS_HASH}</code> is the value of class_hash. Don’t forget to set the <code>STARKNET_NETWORK</code> and <code>STARKNET_WALLET</code> environment variables and <a href="https://www.cairo-lang.org/docs/hello_starknet/account_setup.html#create-account">deploy an account contract</a> before running <code>starknet deploy</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interacting_with_the_contract"><a class="anchor" href="#interacting_with_the_contract"></a>Interacting with the contract</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s update the balance:</p>
</div>
<div id="user-auth-increase-balance" class="literalblock">
<div class="content">
<pre>starknet invoke \
    --address ${CONTRACT_ADDRESS} \
    --abi user_auth_abi.json \
    --function increase_balance \
    --inputs 4321</pre>
</div>
</div>
<div class="paragraph">
<p>You can query the transaction status:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet tx_status --hash TX_HASH</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, after the transaction is executed (status <code>ACCEPTED_ON_L2</code> or <code>ACCEPTED_ON_L1</code>) you may query the user’s balance:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet call \
    --address ${CONTRACT_ADDRESS} \
    --abi user_auth_abi.json \
    --function get_balance \
    --inputs ${ACCOUNT_ADDRESS}</pre>
</div>
</div>
<div class="paragraph">
<p>You should get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>4321</pre>
</div>
</div>
<div class="paragraph">
<p>Note that if you want to use the <a href="https://www.cairo-lang.org/docs/hello_starknet/cli.html#get-storage-at">get_storage_at</a> CLI command to query the balance of a specific user, you can no longer compute the relevant key by only supplying the name of the storage variable. That is because the balance storage variable now requires an additional argument, namely, the user key. Hence, you will need to supply the additional arguments when acquiring the key used in <code>get_storage_at</code>. In our case, this translates to the following Python code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>from starkware.starknet.public.abi import get_storage_var_address

user = ACCOUNT_ADDRESS
user_balance_key = get_storage_var_address('balance', user)
print(f'Storage key for user {user}:\n{user_balance_key}')</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retrieving-the-revert-reason"><a class="anchor" href="#retrieving-the-revert-reason"></a>Retrieving the revert reason</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s try to invoke <code>increase_balance</code> with a negative amount:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet invoke \
    --address ${CONTRACT_ADDRESS} \
    --abi user_auth_abi.json \
    --function increase_balance \
    --inputs -1000</pre>
</div>
</div>
<div class="paragraph">
<p>Because this transaction is invalid (as the amount is negative), you will get an error from the StarkNet gateway that contains the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{"code": "StarknetErrorCode.TRANSACTION_FAILED", "message": "Error at pc=0:38:\nGot an exception while executing a hint.\nCairo traceback (most recent call last):\nUnknown location (pc=0:522)\nUnknown location (pc=0:484)\nUnknown location (pc=0:590)\n\nError in the called contract (0x548245153813267af2d2793c6e5d60c40cb95f34d7404f2ce75550fafabede0):\nError at pc=0:6:\nGot an exception while executing a hint.\nCairo traceback (most recent call last):\nUnknown location (pc=0:155)\nError message: Amount must be positive. Got: -1000.\nUnknown location (pc=0:129)\n\nTraceback (most recent call last):\n  File \"&lt;hint0&gt;\", line 3, in &lt;module&gt;\nAssertionError: a = 3618502788666131213697322783095070105623107215331596699973092056135872019481 is out of range."}</pre>
</div>
</div>
<div class="paragraph">
<p>This indicates that the CLI could not estimate the transaction fee, because the transaction has failed. For the sake of demonstrating retrieving the revert reason, we will force the transaction to skip the fee estimation mechanism. To do so, add <code>--max_fee 100000000000000000</code> to the former invoke transaction, as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet invoke \
    --address ${CONTRACT_ADDRESS} \
    --abi user_auth_abi.json \
    --function increase_balance \
    --inputs -1000 \
    --max_fee 100000000000000000</pre>
</div>
</div>
<div class="paragraph">
<p>After this, when querying the transaction status, you should get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{
    "tx_failure_reason": {
        "code": "TRANSACTION_FAILED",
        "error_message": "Error at pc=0:32:\nGot an exception while executing a hint.\nCairo traceback (most recent call last):\nUnknown location (pc=0:494)\nUnknown location (pc=0:453)\nUnknown location (pc=0:510)\n\nError in the called contract (0x3632c8d1265888e0eadb518cbf4a83d071d00cd8f946ec72fd661e69eea1963):\nError at pc=0:6:\nGot an exception while executing a hint.\nCairo traceback (most recent call last):\nUnknown location (pc=0:155)\nError message: Amount must be positive. Got: -1000.\nUnknown location (pc=0:129)\n\nTraceback (most recent call last):\n  File \"&lt;hint0&gt;\", line 3, in &lt;module&gt;\nAssertionError: a = 3618502788666131213697322783095070105623107215331596699973092056135872019481 is out of range."
    },
    "tx_status": "REJECTED"
}</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the error message entry states that the error location is unknown. This is because the StarkNet network is not aware of the source code and debug information of a contract. To retrieve the error location and reconstruct the traceback, add the path to the relevant compiled contract in the transaction status query, using the <code>--contracts</code> argument. To better display the error (and only it), add the <code>--error_message</code> flag as well:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>starknet tx_status \
    --hash TX_HASH \
    --contracts ${CONTRACT_ADDRESS}:user_auth_compiled.json \
    --error_message</pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Error at pc=0:28:
Got an exception while executing a hint.
Cairo traceback (most recent call last):
Unknown location (pc=0:494)
Unknown location (pc=0:453)
Unknown location (pc=0:510)

Error in the called contract (0x29cd5db92729052b3268471cf1b2327b61523565adeaa1d659236e806bd4b97):
math.cairo:47:5: Error at pc=0:6:
    a = [range_check_ptr];
    ^*******************^
Got an exception while executing a hint.
Cairo traceback (most recent call last):
user_auth.cairo:15:6
func increase_balance{syscall_ptr: felt*, pedersen_ptr: HashBuiltin*, range_check_ptr}(
     ^**************^
Error message: Amount must be positive. Got: -1000.
user_auth.cairo:20:9
        assert_nn(amount);
        ^***************^

Traceback (most recent call last):
  File "&lt;hint0&gt;", line 3, in &lt;module&gt;
AssertionError: a = 3618502788666131213697322783095070105623107215331596699973092056135872019481 is out of range.</pre>
</div>
</div>
<div class="paragraph">
<p>You should ignore the first part (before <code>Error in the called contract</code>) – it is caused by the account contract.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../calling_contracts/">Calling contracts</a></span>
  <span class="next"><a href="../deploying_from_contracts/">Deploying from contracts</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
<!--  <p>&copy; 2020-2022 StarkWare Industries</p> -->
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: { inlineMath: [["\\(", "\\)"]], displayMath: [["\\[", "\\]"]], ignoreClass: "nostem|nolatexmath" },
  asciimath2jax: { delimiters: [["\\$", "\\$"]], ignoreClass: "nostem|noasciimath" },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
  </body>
</html>
