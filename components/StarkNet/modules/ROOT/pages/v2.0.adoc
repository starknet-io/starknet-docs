[id="perpetual_trading_v2_0"]
= Perpetual Trading (v2.0)

image::withdrawal-flow.png[]

[id="step_1_off_chain_withdrawal_request_initiated_by_the_user"]
== Step 1: Off-Chain Withdrawal Request Initiated by the User

The user submits a `WithdrawalToAddress` request to the off-chain application.&#x20;

This request includes the user's `ethereumAddress` in addition to the user's signature.

[id="step_2_off_chain_withdrawal_transaction"]
== Step 2: Off-Chain Withdrawal Transaction

The off-chain app checks the validity of the withdrawal request according to its business logic and the relevant `positionId` state. If it is valid, it sends the off-chain withdrawal transaction to the StarkEx service.

[id="step_3_withdrawal_included_in_a_batch"]
== Step 3: Withdrawal Included in a Batch

StarkEx verifies that the withdrawal request is valid, according to the relevant business logic statement to be proved, and the relevant `positionId` state. If the withdrawal is valid, it is aggregated to a batch to be submitted on-chain along with a validity proof.&#x20;

[id="step_4_funds_move_to_the_withdrawal_area"]
== Step 4: Funds Move to the Withdrawal Area&#x20;

Upon performing state update, the StarkEx smart contract moves the relevant funds to the withdrawal area, under the user `ethereumAddress`.&#x20;

[id="step_5_on_chain_withdrawal_transaction"]
== Step 5: On-Chain Withdrawal Transaction&#x20;

Once the funds are in the withdrawal area, every user can make an on-chain call to withdraw the funds to the `ethereumAddress` the funds are belonged to. The ownerKey parameter should be the ethereum address, and not the stark key. For more info, see `withdrawals`â€‹.
