= Staking protocol

[IMPORTANT]
====
This page is a deep-dive into Starknet's staking protocol. To learn how to stake on Starknet, go to _xref:guides:staking/overview.adoc[]_.
====

== Introduction

While Starknet is currently still centralized, it is moving towards employing a xref:#protocol[proof-of-stake (PoS) protocol], handing over the responsibilities of maintaining and securing Starknet by producing, attesting, and proving blocks to validators. Naturally, handing over these responsibilities in one day is neither feasible nor desirable. Instead, the PoS protocol is be implemented in four incremental phases, illustrated in following figure:

image::staking-roadmap.png[]

To facilitate this, the protocol's architecture is modular, with each xref:#components[component] handling specific responsibilities, ensuring maximum flexibility and ease of upgrades.

== Protocol

The following sections describe the details of Starknet's PoS protocol. The parameters used in the protocol are summarized in the following table:

[%autowidth]
|===
| Parameter | Value

| Minimum stake for validators
| 20K STRK (1 STRK on Sepolia)

| Epoch size (stem:[E])
| 100-1,000 Blocks

| The block window range to submit an attestation (stem:[W])	
| 16 - 30 Blocks

| Number of epochs used for latency (stem:[k])
| 1	

| Minting curve yearly inflation cap (stem:[C])
| 1.6 (same on Sepolia)

| Withdrawal security lockup
| 21 days (5 minutes on Sepolia)
|===

=== Roles

Starknet's PoS protocol features two options for participation:

* Staking directly as validators: Staking a minimum of 20,000 STRK and earning rewards by handling any responsibilities the protocol requires

* Staking indirectly as delegators: Delegating STRKs to validators who alloe delegation and sharing in their rewards without handling any of their responsibilities
+
[IMPORTANT]
====
Validators can choose whether to allow delegation or not.
====

=== Ephocs

Naturally, the more stake a validator has, the more blocks they need to produce. However, changes in validators' stakes can be applied immediately in order to make things predictable. To resolve this, Starknet's PoS protocol introduces a notion of epochs (similarly to many other protocols).

Epochs represent checkpoints where validators' stakes are set, complemented by a new latency parameter stem:[k], such that changes made in epoch stem:[i] are applied in epoch stem:[i+k].

[NOTE]
====
When validators also produce blocks, stem:[k] will be greater or equal to 2, as the producer of the first block of epoch stem:[j] must be known before the last block of epoch stem:[j-1]. As long as validators are not yet producing blocks, stem:[k] may be equal to one.
====

The following figure illustrates a scenario where in epoch stem:[i] validator stem:[A] with has 50K STRK staked and someone delegates an additional 10K STRK to them, and in epoch stem:[i+1] someone undelegates 30K STRK from stem:[A]:

image::epochs-example.png[]

=== Responsibilities

// ==== Running a full node

==== Block attestation

The primary proposed change in Staking v2 is the introduction of a block attestation mechanism for Validators. This section outlines the technical details of the attestation process. For now, epochs are treated as groups of E blocks (a detailed explanation will follow in a later section).

Each Validator is assigned a block per epoch based on the following formula:
block_number=Hash(staked_amount,epoch_id,validator_address)%(E−W)

When the block_number is the relative number within the epoch, and W represents the range of blocks applicable for attestation submittal.
During each epoch, Validators have the opportunity to attest to their assigned block by submitting an attest transaction. This transaction includes the block hash of the attested block and must be included within a specific attestation window. If T represents the block number that meets the matching criteria, the attestation window spans from block T+11 to T+W (for instance, where W = 20). Each Validator is required to perform only one attestation per epoch.

This mechanism ensures Validators actively use full nodes, as they need to track block hashes continuously. Additionally, the attestation reflects their activity and is publicly verifiable. This ensures Validators’ reliability is publicly tested, which is crucial before Starknet’s security and liveness depend on them.

Note that in this proposal, the work is the same for all Validators, and only the rewards are proportional to their stake. This is done to simplify the implementation, so time and effort may be saved for the later stages. This is essential as testing Validators’ reliability is crucial before handing them core responsibilities. Also, Running a full node is the main cost and effort, which is obligatory for all Validators.

Lastly, the exact parameters of epoch length (E) and attestation window (W) will be determined later and added to this proposal, but here are some thoughts about what is bounding them:

E should be large enough to keep the Operator’s cost sensible—even on a day with high gas fees, the yield for an Operator that has staked only 20K STRK over an epoch should be significantly more than the cost of the transaction it would have to submit. E should be small enough so latency on activities that depend on epoch (such as adding or removing stake) will not be too cumbersome.

W should be small to ensure liveness. But also - not too small. We want to incentivize people to react in real-time but also to avoid scenarios where, due to sporadic spikes in the network, the validator failed to submit a transaction in time.

=== Rewards

Rewards are distributed based on the amount staked and the commission policy constant stem:[CP] set by the validator. The yearly reward percentages are calculated using the following formulas:

* For delegators:
+
[stem]
++++
\text{stake_delegated} \cdot (1 - CP) \cdot \frac{M}{S}
++++

* For validators:
+
[stem]
++++
\left(\text{self_stake} + \text{total_stake_delegated} \cdot CP\right) \cdot \frac{M}{S}
++++

where stem:[M] and stem:[S] are defined by the xref:#minting_curve[].

==== Minting curve

The minting curve balances participation and inflation by adjusting rewards based on the total STRK locked in the protocol. It is defined by the following formula:

[stem]
++++
M = \frac{C}{10} \times \sqrt{S}
++++

where:

* stem:[S] is the staking rate as a percentage of the total token supply
* stem:[M] is the annual minting rate as a percentage of the total token supply
* stem:[C] is the maximum theoretical inflation percentage, currently set to 1.6%

=== Latencies

Funds are subject to a 21-day security lockup after signaling an unstake intent, but delegators can switch between validators without waiting for the full lockup period*, promoting a competitive delegation market.

Starting phase 2, entry and exit latencies are determined by xref:epochs[ephocs].

== Components

[TIP]
====
For more technical details, you can refer to the full staking specification document available in: https://github.com/starkware-libs/starknet-staking/blob/main/docs/spec.md[Staking Repository Spec].
====

The implementation of Starknet's staking protocol is divided into several contracts, summarized in the following figure:

image::staking-architecture.png[]

This modular architecture allows for targeted upgrades and improvements without affecting the entire system. Access control mechanisms are also in place to ensure that only authorized parties can make critical changes, further enhancing the security of the staking process.

=== Staking contract

The staking contract is the core of the staking system, managing the entire lifecycle of staking, from initial staking to claiming rewards and unstaking. Its key functions include:

* `stake`: Allows users to stake their STRK tokens
* `increase_stake`: Allows existing validators to increase their stake
* `unstake_intent`: Initiates the unstaking process
* `unstake_action`: Finalizes the unstaking process, returning tokens to the validator address
* `claim_rewards`: Allows users to claim rewards

[NOTE]
====
The staking contract stores the `StakerInfo` data structure, which holds detailed information about each validator, including their staked amount, unclaimed rewards, delegation details, and operational parameters, and helps to ensure that validators' information is accurately tracked and updated.
====

=== Delegation pooling contract

All delegation interactions, such as entering or exiting a pool, are enabled through the delegation pooling contract, which tracks each delegator's contribution, calculates their rewards, and manages the delegation lifecycle. Its key functions are:

* `enter_delegation_pool`: Allows users to delegate their tokens to the pool associated with a validator. This function transfers the tokens, updates the delegator's record, and integrates them into the validator's pool.

* `add_to_delegation_pool`: Enables existing delegators to increase their delegation amount. The contract updates the pool's total and recalculates the member's rewards.

* `exit_delegation_pool_intent`: Initiates the process for a delegator to exit the pool. Similar to validators, the delegator's funds are locked for a period before they can be withdrawn.

* `exit_delegation_pool_action`: Finalizes the exit process for a delegator, returning their tokens and any unclaimed rewards.

* `switch_delegation_pool`: Allows a delegator to transfer their delegated stake from one validator's pool to another, facilitating dynamic delegation strategies.

* `claim_rewards`: Transfers the delegator's earned rewards to their specified reward address.

[NOTE]
====
The delegation pooling contract stores the `PoolMemberInfo` data structure, which holds information about each delegator's contributions, rewards, and status within the pool, and helps manage and calculate the delegation and reward distribution processes for pool members.
====

=== Reward Supplier Contract

The reward supplier contract is responsible for calculating and supplying the staking rewards based on the minting curve, ensuring the rewards are distributed fairly and in accordance with the protocol's economic parameters. Its key Functions are:

* `calculate_staking_rewards`: Computes the rewards based on the current staking rate and the minting curve, updating the staking contract with the amount to be distributed.

* `claim_rewards`: Handles the transfer of rewards to the staking contract, ensuring that the correct amount is distributed to validators and delegators.

=== Minting Curve Contract

The minting curve contract defines the economic model that governs reward distribution, ensuring the network's inflation is managed while incentivizing participation in staking. Its key functions are:

* `yearly_mint`: Returns the amount of STRK tokens to be minted annually based on the current staking rate. This function uses a square root formula to balance rewards and inflation.

* `update_total_supply`: Updates the total supply of STRK tokens, ensuring that the minting calculations remain accurate.